#!/usr/bin/env python3
"""
Mobile Digital Forensics Investigation Tool
Malware / Anomaly Analysis for Call Logs

This module detects malware-related indicators from call behaviour.
It does NOT claim malware existence â€” only forensic red flags.
"""

import json
import re
from datetime import datetime
from pathlib import Path


# -------------------------------
# CONFIGURATION
# -------------------------------
PROCESSED_DIR = Path(__file__).parent.parent / "evidence" / "processed"
OUTPUT_FILE = Path(__file__).parent.parent / "analysis" / "malware_call_analysis_report.json"

SHORT_CALL_SECONDS = 15
MIN_SUSPICIOUS_CALLS = 3


# -------------------------------
# DATA LOADING
# -------------------------------
def load_calls():
    calls_file = PROCESSED_DIR / "calls.json"

    if not calls_file.exists():
        print("No calls.json found")
        return []

    with open(calls_file, "r", encoding="utf-8") as f:
        calls = json.load(f)

    print(f"Loaded {len(calls)} call records")
    return calls


# -------------------------------
# MALWARE INDICATOR ANALYSIS
# -------------------------------
def detect_suspicious_call_pattern(calls):
    findings = []

    suspicious_calls = []

    for call in calls:
        if call.get("type") != "outgoing":
            continue

        details = call.get("details", "").lower()

        # Extract number
        number_match = re.search(r"\+\d[\d\-]+", details)
        if not number_match:
            continue

        number = number_match.group(0)

        # Check international (not +91)
        if number.startswith("+91"):
            continue

        # Extract duration if present
        duration_match = re.search(r"(\d+)\s*seconds", details)
        duration_seconds = int(duration_match.group(1)) if duration_match else None

        # Suspicious if very short call
        if duration_seconds is not None and duration_seconds <= SHORT_CALL_SECONDS:
            suspicious_calls.append({
                "timestamp": call["timestamp"],
                "number": number,
                "duration": duration_seconds
            })

    if len(suspicious_calls) >= MIN_SUSPICIOUS_CALLS:
        first = suspicious_calls[0]
        findings.append({
            "timestamp": first["timestamp"],
            "source": "CALL",
            "type": "outgoing",
            "details": (
                "Multiple short-duration international outgoing calls detected "
                "(possible command-and-control or malicious dialer activity)"
            )
        })

    return findings


# -------------------------------
# REPORT
# -------------------------------
def save_report(findings):
    report = {
        "analysis_timestamp": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
        "analysis_type": "malware_call_analysis",
        "total_indicators": len(findings),
        "findings": findings
    }

    OUTPUT_FILE.parent.mkdir(parents=True, exist_ok=True)

    with open(OUTPUT_FILE, "w", encoding="utf-8") as f:
        json.dump(report, f, indent=2)

    print(f"Malware call analysis report saved to: {OUTPUT_FILE}")


# -------------------------------
# MAIN
# -------------------------------
def main():
    print("Mobile Forensics - Malware Call Analysis")
    print("=" * 40)

    calls = load_calls()
    findings = detect_suspicious_call_pattern(calls)

    save_report(findings)

    print("\nMalware Call Analysis Summary:")
    print(f"  Total indicators detected: {len(findings)}")
    print(f"  Report saved to: {OUTPUT_FILE}")


if __name__ == "__main__":
    main()
