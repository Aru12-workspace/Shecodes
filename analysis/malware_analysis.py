#!/usr/bin/env python3
"""
Mobile Digital Forensics Investigation Tool - Malware Analysis Module

This module performs rule-based malware indicator detection
on processed application evidence.
"""

import json
import os
from datetime import datetime
from pathlib import Path


PROCESSED_DIR = Path(__file__).parent.parent / "evidence" / "processed"
OUTPUT_FILE = Path(__file__).parent.parent / "analysis" / "malware_analysis_report.json"


def load_apps(apps_file):
    apps = []

    if not os.path.exists(apps_file):
        print(f"No apps.json found for malware analysis: {apps_file}")
        return apps

    with open(apps_file, "r", encoding="utf-8") as f:
        apps = json.load(f)

    print(f"Loaded {len(apps)} app records")
    return apps


def detect_suspicious_apps(apps):
    findings = []

    suspicious_keywords = ["spy", "monitor", "tracker", "rat", "keylogger"]

    for app in apps:
        details = app.get("details", "").lower()
        for keyword in suspicious_keywords:
            if keyword in details:
                findings.append({
                    "timestamp": app["timestamp"],
                    "source": "APP",
                    "type": "modified",
                    "details": f"Suspicious app activity detected: {details}"
                })
                break

    return findings


def save_report(findings, output_file):
    report = {
        "analysis_timestamp": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
        "analysis_type": "malware_analysis",
        "total_indicators": len(findings),
        "findings": findings
    }

    os.makedirs(os.path.dirname(output_file), exist_ok=True)
    with open(output_file, "w", encoding="utf-8") as f:
        json.dump(report, f, indent=2)

    print(f"Malware analysis report saved to: {output_file}")


def main():
    print("Mobile Forensics - Malware Analysis")
    print("=" * 40)

    # Use case_002 for this pipeline execution
    base_path = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
    processed_dir = os.path.join(base_path, "cases", "case_002", "evidence", "processed")
    apps_file = os.path.join(processed_dir, "apps.json")

    apps = load_apps(apps_file)
    findings = detect_suspicious_apps(apps)

    output_dir = os.path.join(base_path, "cases", "case_002", "analysis")
    output_file = os.path.join(output_dir, "malware_analysis_report.json")
    save_report(findings, output_file)

    print("\nMalware Analysis Summary:")
    print(f"  Total indicators: {len(findings)}")
    print(f"  Report saved to: {output_file}")


if __name__ == "__main__":
    main()
